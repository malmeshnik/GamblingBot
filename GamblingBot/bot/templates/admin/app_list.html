<div id="custom-sidebar" class="module">
  <div class="sidebar-header">
    <a href="/admin/bot/bot/add" class="top-btn add-bot">+ –î–æ–¥–∞—Ç–∏ –±–æ—Ç–∞</a>
    <a href="/admin/bot/folder/add" class="top-btn add-bot">+ –î–æ–¥–∞—Ç–∏ –ø–∞–ø–∫—É</a>
    <a href="/admin/bot/botstatistics" class="top-btn stats-bot">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—Å—ñ—Ö –±–æ—Ç—ñ–≤</a>
  </div>
  <ul class="folder-list">
    {% for folder in app_list %}
      <li class="folder-{{ folder.id }}">
        <table data-folder-id="{{ folder.id }}">
          <caption class="toggle-folder">
            <b class="folder_name">
              <a href="/admin/bot/folder/1/change/">{{ folder.name }}</a>
            </b>
          </caption>
          <tbody class="model-list">
            <tr>
              <td>
                <a href="/admin/bot/message/?folder__id__exact={{ folder.folder_id }}">
                  <b>–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</b>
                </a>
              </td>
            </tr>
            <tr>
              <td>
                <a href="/admin/bot/scheduledmessage/?folder__id__exact={{ folder.folder_id }}">
                  <b>–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</b>
                </a>
              </td>
            </tr>
            <tr>
              <td>
                <a href="/admin/bot/campain/?folder__id__exact={{ folder.folder_id }}">
                  <b>–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è —Å—Ç–∞—Ä—Ç—É</b>
                </a>
              </td>
            </tr>
            <tr>
              <td>
                <a href="/admin/bot/botstatistics/?folder__id__exact={{ folder.folder_id }}">
                  <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b>
                </a>
              </td>
            </tr>
          </tbody>
          <tbody class="bot-list">
            {% for app in folder.bots %}
            <tr>
              <td>
                <table data-bot-id="{{ app.bot_id }}">
                  <caption class="toggle-bot">
                    <a href="/admin/bot/bot/{{ app.bot_id }}/change/">
                      <b class="app_name">{{ app.name }}</b>
                    </a>
                  </caption>
                  <tbody class="model-list">
                    {% for model in app.models %}
                    <tr class="model-{{ model.name|lower }}">
                      <td>
                        <a href="{{ model.admin_url }}">
                          <b>{{ model.name }}</b>
                        </a>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </li>
      <br>
    {% endfor %}
  </ul>
</div>

<div>
  <a href="/admin/bot/bot" class="top-btn add-bot">–í—Å—ñ –±–æ—Ç–∏</a>
</div>

<style>
#custom-sidebar ul,
#custom-sidebar li {
    list-style: none;
    margin: 0;
    padding: 0;
}

#custom-sidebar table {
  width: 100%;
}

.app_name {
  color: #fff;
}

/* ==== –í–µ—Ä—Ö–Ω—ñ –∫–Ω–æ–ø–∫–∏ ==== */
.sidebar-header {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.top-btn {
  flex: 1;
  padding: 8px 12px;
  font-size: 14px;
  font-weight: 600;
  text-align: center;
  text-decoration: none;
  border-radius: 6px;
  transition: all 0.2s ease-in-out;
  cursor: pointer;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // ====== –ü–∞–ø–∫–∏ ======
  document.querySelectorAll('#custom-sidebar table[data-folder-id]').forEach((table) => {
    const caption = table.querySelector('caption.toggle-folder');
    // —Ö–æ–≤–∞—î–º–æ —ñ –±–æ—Ç—ñ–≤, —ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –ø–∞–ø–∫–∏
    const tbodyBots = table.querySelector('tbody.bot-list');
    const tbodyModels = table.querySelector('tbody.model-list'); // <--- –¥–ª—è –ø–æ—Å–∏–ª–∞–Ω—å –ø–∞–ø–∫–∏

    if (!caption) return;

    const folderId = table.dataset.folderId;
    const storageKey = `folder-open-${folderId}`;

    let icon = caption.querySelector('.toggle-icon');
    if (!icon) {
      icon = document.createElement('span');
      icon.className = 'toggle-icon';
      caption.prepend(icon);
    }

    const isOpen = localStorage.getItem(storageKey) === 'true';
    if (tbodyBots) tbodyBots.style.display = isOpen ? 'table-row-group' : 'none';
    if (tbodyModels) tbodyModels.style.display = isOpen ? 'table-row-group' : 'none';
    caption.classList.toggle('is-open', isOpen);

    caption.addEventListener('click', (e) => {
      e.preventDefault();
      const currentlyOpenBots = tbodyBots ? tbodyBots.style.display !== 'none' : false;
      const currentlyOpenModels = tbodyModels ? tbodyModels.style.display !== 'none' : false;
      const nextOpen = !(currentlyOpenBots || currentlyOpenModels);

      if (tbodyBots) tbodyBots.style.display = nextOpen ? 'table-row-group' : 'none';
      if (tbodyModels) tbodyModels.style.display = nextOpen ? 'table-row-group' : 'none';
      caption.classList.toggle('is-open', nextOpen);
      localStorage.setItem(storageKey, String(nextOpen));
    });
  });

  // ====== –ë–æ—Ç–∏ ====== (–∑–∞–ª–∏—à–∞—î–º–æ –±–µ–∑ –∑–º—ñ–Ω)
  document.querySelectorAll('#custom-sidebar table[data-bot-id]').forEach((table) => {
    const caption = table.querySelector('caption.toggle-bot');
    const tbody = table.querySelector('tbody.model-list');
    if (!caption || !tbody) return;

    const botId = table.dataset.botId;
    const storageKey = `bot-open-${botId}`;

    let icon = caption.querySelector('.toggle-icon');
    if (!icon) {
      icon = document.createElement('span');
      icon.className = 'toggle-icon';
      caption.prepend(icon);
    }

    const isOpen = localStorage.getItem(storageKey) === 'true';
    tbody.style.display = isOpen ? 'table-row-group' : 'none';
    caption.classList.toggle('is-open', isOpen);

    caption.addEventListener('click', (e) => {
      if (e.target.closest('a')) return;
      e.preventDefault();
      const currentlyOpen = tbody.style.display !== 'none';
      const nextOpen = !currentlyOpen;

      tbody.style.display = nextOpen ? 'table-row-group' : 'none';
      caption.classList.toggle('is-open', nextOpen);
      localStorage.setItem(storageKey, String(nextOpen));
    });
  });
});
</script>